name: PR Size Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  label-size:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Label PR based on size
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // Get PR files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Calculate total changes
            let additions = 0;
            let deletions = 0;
            let totalChanges = 0;

            files.forEach(file => {
              // Skip generated files and lock files
              if (!file.filename.includes('.g.cs') &&
                  !file.filename.includes('packages.lock.json') &&
                  !file.filename.includes('package-lock.json')) {
                additions += file.additions;
                deletions += file.deletions;
                totalChanges += file.changes;
              }
            });

            // Determine size label
            let sizeLabel = '';
            if (totalChanges < 10) {
              sizeLabel = 'size/XS';
            } else if (totalChanges < 50) {
              sizeLabel = 'size/S';
            } else if (totalChanges < 200) {
              sizeLabel = 'size/M';
            } else if (totalChanges < 500) {
              sizeLabel = 'size/L';
            } else if (totalChanges < 1000) {
              sizeLabel = 'size/XL';
            } else {
              sizeLabel = 'size/XXL';
            }

            // Get current labels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            // Remove old size labels
            const sizeLabels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL', 'size/XXL'];
            for (const label of currentLabels) {
              if (sizeLabels.includes(label.name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label.name
                }).catch(() => {
                  // Ignore errors if label doesn't exist
                });
              }
            }

            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [sizeLabel]
            });

            // Add comment with PR statistics
            const comment = `üìä **PR Size Analysis**

            - **Total Changes:** ${totalChanges} lines
            - **Additions:** +${additions} lines
            - **Deletions:** -${deletions} lines
            - **Files Changed:** ${files.length}
            - **Size Label:** \`${sizeLabel}\`

            ${totalChanges > 500 ? '‚ö†Ô∏è This PR is quite large. Consider breaking it into smaller PRs for easier review.' : ''}
            ${totalChanges < 50 ? '‚úÖ Small PR - should be quick to review!' : ''}`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Size Analysis')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

            console.log(`Labeled PR #${prNumber} with ${sizeLabel}`);
